<!DOCTYPE html>
<html lang="en-us">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Instrumenting Go Source Code
        | APM Go Agent Reference [1.x]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="APM Go Agent Reference [1.x]" /><link rel="up" href="getting-started.html" title="Getting started" /><link rel="prev" href="installation.html" title="Installation" /><link rel="next" href="configuration.html" title="Configuration" /><meta name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta name="DC.type" content="Learn/Docs/APM Go Agent/Reference/1.x" /><meta name="DC.subject" content="APM" /><meta name="DC.identifier" content="1.x" />
    

    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#ffffff">
<meta name="apple-mobile-web-app-title" content="Elastic">
<meta name="application-name" content="Elastic">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/mstile-144x144.png">
<meta name="theme-color" content="#ffffff">
<meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
<meta name="yandex-verification" content="d8a47e95d0972434" />
<!-- DC tags section -->
<link rel="schema.DC" href="http://purl.org/dc/elements/1.1/" >
<link rel="schema.DCTERMS" href="http://purl.org/dc/terms/" >



	



<!-- end DC tags -->


	<meta name="description" content="" />



	<meta name="localized" content="true" />


















		
			<meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
		

		

    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <!-- For third-generation iPad with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <!-- For iPhone with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <!-- For first- and second-generation iPad: -->
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">

	 

    <!-- css -->
    <link href="/static/css/main.css" rel="stylesheet">
    
    

    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/jquery.cookie.js"></script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

  <script type="text/javascript">
  // -------------------- set language based on browser language --------------------
  var lang = '/'+(navigator.language || navigator.userLanguage).slice(0,2)+'/',
      locales = {
        '/en':'/',
        '/de/': '/de/',
        '/fr/': '/fr/',
        '/ja/':'/jp/',
        '/ko/':'/kr/',
        '/zh/':'/cn/',
        '/es/': '/es/'
      },
      localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}',
      currentlocale = JSON.parse(localeUrl).relative_url_prefix;

  if($.cookie("is_lang_detected") == undefined){
    if(locales[lang] != undefined && locales[lang] != currentlocale){
      locale_lang_url = locales[lang] + window.location.pathname.slice(1,window.location.pathname.length);
      $.cookie("is_lang_detected",true ,{ path: '/'}); 
      window.location = locale_lang_url;
    } 
  }
        
  // --------------------- end of set language based on browser language -----------------
  </script>

  

	
	<link type="text/css" rel="stylesheet" href="/static/css/guide.css" />


  
<link rel="stylesheet" type="text/css" href="styles.css" />

</head>
  <body >
  	<!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5"
                              height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- new ga for staging server -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>
    <!-- new ga for staging server -->

    <!-- Elastic APM -->
<script src="/static/js/elastic-apm-js-base.umd.min.2.2.0.js"></script>


<script type="text/javascript">
  var active;
  
  active = Math.random() < 1 //0.9 
  
  elasticApm.init({
    active: active,
    serviceName: "elastic-co-frontend",
    serverUrl: "https://elastic-co-apm-server.app.elstc.co"
  })

  var pageLoadName
  var pathname = window.location.pathname.replace(/\/es|\/pt|\/jp|\/pt|\/fr|\/kr|\/cn|\/de/g, '')
  var parts = pathname.split('/');

  if (parts.length && parts[1] === 'blog') {
    if (parts.length === 2) {
      pageLoadName =  '/blog';
    }
    else if (parts[2] === 'category') {
      pageLoadName =  '/blog/category';
    }
    else if (parts[2] === 'archive') {
      pageLoadName =  '/blog/archive';
    }
    else {
      pageLoadName =  '/blog/detail';
    }
  }
  else if (parts.length && parts[1] === 'elasticon') {
    if (parts.length === 2) {
      pageLoadName =  '/elasticon';
    }
    else if (parts.length === 5 && (parts[2] === 'conf' || parts[2] === 'tour')) {
      pageLoadName =  '/elasticon/overview';
    }
    else if (parts.length > 5 && (parts[2] === 'conf' || parts[2] === 'tour')) {
      pageLoadName =  '/elasticon/video';
    }
  }
  else if (parts.length && parts[1] === 'guide') {
    pageLoadName =  '/guide';
  }
  else if (parts.length === 2 && parts[1] === 'videos') {
    pageLoadName =  '/videos';
  }
  else if (parts.length > 2 && parts[1] === 'videos') {
    pageLoadName =  '/videos/detail';
  }
  else if (parts.length > 2 && parts[1] === 'webinars') {
    pageLoadName =  '/webinars/detail';
  }
  else {
    pageLoadName =  window.location.pathname;
  }

  console.log('apm pageLoadName:', pageLoadName, parts)
  elasticApm.setTags({env:"production"});
  elasticApm.setInitialPageLoadName(pageLoadName);
</script>

<!-- Elastic APM -->


    <!-- Header Section -->
    
<header class="header-wrapper">
  



  




<div class="navigation-wrapper">
  <div class="container">
    <nav class="navbar">
    <!-- Brand and toggle get grouped for better mobile display -->

    <div class="navbar-mobile-header navbar-header mr-20 mr-xs-0">
      <div class="row hidden-sm hidden-md hidden-lg">
        <div class="col-xs-5 hidden-sm hidden-md hidden-lg">
          <div class="navbar-mobile-header-icon navbar-mobile-header-icon-out">
            <span></span>
            <span></span>
            <span></span>
          </div>
          
        </div>
        <div class="col-xs-2 text-center">
          <div class="navbar-brand" id="elastic">
            <div id="logo">
              <a class="logo-m hidden-sm hidden-md hidden-lg" href="/">
                <img src="/assets/blta09706b1c5cc1e99/elastic-logo-mobile.svg" alt="elastic-logo-mobile">
              </a>
            </div>
          </div>
        </div>
        <div class="col-xs-5 hidden-sm hidden-md hidden-lg text-right">
          <ul class="menu-m hidden-sm hidden-md hidden-lg">
            <li class=""><a class="icon-contact" href="/contact"></a></li>

            <li id="searchbar"><a class="button icon" href="#" alt="Search"></a></li>
            <li class="lang global-language">
                
                  
                
                  
                    <a href="#">EN</a>
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
              <ul class="language-list">
                
                  
                    
                  
                  
                  <li><a href="/de/" data-value="/de/" id="locale-select">Deutsch</a></li>
                  
                
                  
                    
                  
                  
                  <li><a href="#" data-value="/" id="locale-select">English</a></li>
                  
                
                  
                    
                  
                  
                  <li><a href="/es/" data-value="/es/" id="locale-select">Español</a></li>
                  
                
                  
                    
                  
                  
                  <li><a href="/fr/" data-value="/fr/" id="locale-select">Français</a></li>
                  
                
                  
                    
                  
                  
                  <li><a href="/jp/" data-value="/jp/" id="locale-select">日本語</a></li>
                  
                
                  
                    
                  
                  
                  <li><a href="/kr/" data-value="/kr/" id="locale-select">한국어</a></li>
                  
                
                  
                    
                  
                  
                  <li><a href="/cn/" data-value="/cn/" id="locale-select">简体中文</a></li>
                  
                
              </ul>
            </li>
          </ul>
        </div>
      </div>

      <div class="navbar-brand hidden-xs" id="elastic">
        <div id="logo">
          <a class="hidden-xs" id="elastic-logo" href="/">
            <img src="/assets/blt244a845f141977c3/elastic-logo.svg" alt="elastic-logo">
          </a>
        </div>
      </div>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse mobile-inner-nav">
      <nav class="nav navbar-nav primary-nav-hover" id="nav">
        <ul>
        
          
            
              
            
            <li>
              <a class=" " href="/products">Products</a>
            </li>
          
        
          
            
              
            
            <li>
              <a class=" " href="/cloud">Cloud</a>
            </li>
          
        
          
            
              
            
            <li>
              <a class=" " href="/services">Services</a>
            </li>
          
        
          
            
              
            
            <li>
              <a class=" " href="/use-cases">Customers</a>
            </li>
          
        
          
            
              
            
            <li>
              <a class=" " href="/learn">Learn</a>
            </li>
          
        
          
        
        </ul>
      </nav>
      <nav class="nav navbar-nav navbar-right hidden-xs">
        <ul>
          <li class="hidden-xs hidden-sm"><a href="/downloads">downloads</a></li>
          <li class="hidden-xs hidden-md hidden-lg"><a class="icon-download" href="/downloads"></a></li>
          <!-- To set parameters to contact button -->
          
           
            
          

          
            
            
          
          <li class="hidden-xs hidden-sm"><a class="btn btn-secondary btn-contact" href="/contact?storm=global-header-en">contact</a></li>
          <!-- ////////////////ends here///////////////-->          
          <li class="hidden-xs hidden-md hidden-lg"><a class="icon-contact" href="/contact?storm=global-header-en"></a></li>
          <li class="hidden-xs" id="searchbar"><a class="button icon" href="#" alt="Search"></a></li>

          <li class="hidden-xs lang global-language">
                
                  
                
                  
                    <a href="#">EN</a>
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
               <ul class="language-list">
              
                
                  
                
              
              <li><a class="" href="/de/" data-value="/de/">Deutsch</a></li>
              
              
                
                  
                
              
              <li><a class="" href="#" data-value="/">English</a></li>
              
              
                
                  
                
              
              <li><a class="" href="/es/" data-value="/es/">Español</a></li>
              
              
                
                  
                
              
              <li><a class="" href="/fr/" data-value="/fr/">Français</a></li>
              
              
                
                  
                
              
              <li><a class="" href="/jp/" data-value="/jp/">日本語</a></li>
              
              
                
                  
                
              
              <li><a class="" href="/kr/" data-value="/kr/">한국어</a></li>
              
              
                
                  
                
              
              <li><a class="" href="/cn/" data-value="/cn/">简体中文</a></li>
              
              
            </ul>
          </li>
        </ul>
      </nav>
    </div><!-- /.navbar-collapse -->
  </nav>
  </div>
</div>

<div class="header-search-wrapper open-search"> 
  <div class="container">
    <div class="big-search">
      <i class="big-search-icon"></i>
      <form id="searchfrm" name="searchForm" autocomplete="on" action="/search" method="get">
        <ul class="tags-wrapper">
          <li class="search-field"><input type="text" name="q" id="autocomplete" class="form-control global-input" autocomplete="off"></li>
        </ul>
      </form>
      <a class="header-search-cancel" href="#"></a>
    </div>
    <div class="nav-auto-complete"></div>
  </div>
</div>
</header>
<link rel="stylesheet" type="text/css" href="/static/css/horizon-swiper.min.css">
<style> 
    
      .m-shortcuts li a.m-search {
        background: url("/assets/blt7b9c4fe6528dc4ef/m-search-icon.png") no-repeat scroll center center rgba(0, 0, 0, 0);
        background-size: contain;}
    
      .m-shortcuts li a.m-docs {
        background: url("/assets/blt44d8b7530a76d01c/m-guide-icon.png") no-repeat scroll center center rgba(0, 0, 0, 0);
        background-size: contain;}
    
      .m-shortcuts li a.m-contact {
        background: url("/assets/blt878040795c9d083b/m-contact-icon.png") no-repeat scroll center center rgba(0, 0, 0, 0);
        background-size: contain;}
    
    
</style>
<script type="text/javascript" src="/static/js/horizon-swiper.min.js"></script>
<script type="text/javascript">
  $(document).ready( function(){
    // if($('#scrollable-pane li').length > 3){
      $('.horizon-swiper').horizonSwiper({
        showItems: 3,
        arrows: true
      }); 
    // }
    
    $('.navbar-toggle').on('click', function(){
      $('.mobile-navigation, .menu-open').hide();
      $('.navigation-wrapper').addClass('mobile-navigation');
      $('.navbar').addClass('menu-open');
      $('.menu-close').show();
    });
    $('.menu-close').on('click', function(){
      $('.navigation-wrapper').removeClass('mobile-navigation');
      $('.navbar').removeClass('menu-open');
      $('.menu-close').hide();
    });

    var active_url = "";

    $(".navbar-mobile-header-icon").click(function(index){
      $('.navigation-wrapper').toggleClass('menu-overlay');
      $(this).toggleClass("navbar-mobile-header-icon-click navbar-mobile-header-icon-out");
      $(".mobile-inner-nav").slideToggle(500);
      $(".mobile-inner-nav .navbar-nav a").each(function( index ) {
        $(this).css({'animation-delay': (index/25)+'0.4s'});
      });
    });

    $('.dropdown-btn').on('click', function(e){
      e.preventDefault();
      setDropdown();
    });
    
    function setDropdown() {
      $('#myDropdown').slideToggle();
    }

    $('body').on('click', function(event){
      if (!event.target.matches('.dropdown-btn')) {

        var dropdowns = $(".dropdown-content");
        var i;
        for (i = 0; i < dropdowns.length; i++) {
          var openDropdown = dropdowns[i];
          if (openDropdown.classList.contains('show')) {
            openDropdown.classList.remove('show');
          }
        }
      }
    });

    // if($(window).width() < 769){
    //   var $item = $('.scrollable-panel li'), 
    //       visible = 3, //Set the number of items that will be visible
    //       index = 0, //Starting index
    //       endIndex = ( $item.length / visible ) - 1; //End index (NOTE:: Requires visible to be a factor of $item.length... You can improve this by rounding...)

    //   $('#right-arrow').click(function(){
    //     if(index < endIndex ){
    //       index++;
    //       $item.animate({'left':'-=300px'});
    //     }
    //   });

    //   $('#left-arrow').click(function(){
    //     if(index > 0){
    //       index--;            
    //       $item.animate({'left':'+=300px'});
    //     }
    //   });
    // }
  });
  $(window).resize(function () {
    $('.horizon-swiper').horizonSwiper({
      showItems: 3,
      arrows: true
    });
  });
</script>
    
      


  





  
  
  
  
    <div class="tertiary-nav bdr-btm-e0e0e0">
      <div class="container">
        <div class="p-t-b-15 clearfix">
          <div class="breadcrum-wrapper pull-left text-left">
          
            <a href="/guide">Docs</a> 
          
          </div>
          
          
          
        </div>
      </div>
    </div>

    <div class="nav-mobile-dropdown hidden-sm hidden-md hidden-lg bdr-btm-e0e0e0 clearfix">
      <div class="container text-right">
        <div class="breadcrum-wrapper pull-left text-left">
          
              <a href="/guide">Docs</a>
          
        </div>
        
        
      </div>
    </div>
  


<style type="text/css">

  
</style>
    
    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">   
          
            
        			<!-- <div class="pageheader">
	<div class="common-container">
		
			<h2 class="page-title">Guide template</h2>
		
	</div>
</div> -->


        		
          

          
	<section id="guide" lang="en">
		<div class="container">
			<div class="row">
			  <!-- start body -->
				
            <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
            <!-- start body -->
<div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">APM Go Agent Reference
      [1.x]
    </a></span> » <span class="breadcrumb-link"><a href="getting-started.html">Getting started</a></span> » <span class="breadcrumb-node">Instrumenting Go Source Code</span></div><div class="navheader"><span class="prev"><a href="installation.html">
              « 
              Installation</a>
           
        </span><span class="next">
           
          <a href="configuration.html">Configuration
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="instrumenting-source"></a>Instrumenting Go Source Code<a href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><p>At present, Go applications must be instrumented manually at the source code level.
Where possible, you should use the <a class="link" href="instrumenting-source.html#builtin-modules" title="Built-in Modules">built-in instrumentation modules</a>
to report transactions served by web and RPC frameworks in your application. If the
built-in modules are not suitable, please refer to <a class="link" href="instrumenting-source.html#custom-instrumentation" title="Custom instrumentation">Custom Instrumentation</a>.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="builtin-modules"></a>Built-in Modules<a href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>Below we describe the built-in instrumentation modules.</p><p>For each of the server instrumentation modules, a transaction is reported for each handled
request. The transaction will be stored in the request context, which can be obtained through
that framework’s API. The request context can be used for reporting <a class="link" href="instrumenting-source.html#custom-instrumentation-spans" title="Spans">custom spans</a>.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="builtin-modules-apmecho"></a>module/apmecho<a href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>Package apmecho provides middleware for the <a class="ulink" href="https://github.com/labstack/echo" target="_top">Echo</a> web framework.</p><p>For each request, a transaction is stored in the request context, which can be obtained via
<a class="ulink" href="https://godoc.org/github.com/labstack/echo#Context" target="_top">echo.Context</a><code class="literal">.Request().Context()</code> in your handler.</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">import (
        "github.com/labstack/echo"
        "go.elastic.co/apm/module/apmecho"
)

func main() {
        e := echo.New()
        e.Use(apmecho.Middleware())
        ...
}</pre></div><p>The apmecho middleware will recover panics and send them to Elastic APM,
so you do not need to install the echo/middleware.Recover middleware.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="builtin-modules-apmgin"></a>module/apmgin<a href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>Package apmgin provides middleware for the <a class="ulink" href="https://gin-gonic.github.io/gin/" target="_top">Gin</a> web framework.</p><p>For each request, a transaction is stored in the request context, which can be obtained via
<a class="ulink" href="https://godoc.org/github.com/gin-gonic/gin#Context" target="_top">gin.Context</a><code class="literal">.Request.Context()</code> in your handler.</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">import (
        "go.elastic.co/apm/module/apmgin"
)

func main() {
        engine := gin.New()
        engine.Use(apmgin.Middleware(engine))
        ...
}</pre></div><p>The apmgin middleware will recover panics and send them to Elastic APM, so you do not need to install the gin.Recovery middleware.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="builtin-modules-apmbeego"></a>module/apmbeego<a href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>Package apmbeego provides middleware for the <a class="ulink" href="https://beego.me/" target="_top">Beego</a> web framework.</p><p>For each request, a transaction is stored in the request context, which can be obtained via
<a class="ulink" href="https://godoc.org/github.com/astaxie/beego/context#Context" target="_top">beego/context.Context</a><code class="literal">.Request.Context()</code>
in your controller.</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">import (
        "github.com/astaxie/beego"

        "go.elastic.co/apm/module/apmbeego"
)

type thingController struct{beego.Controller}

func (c *thingController) Get() {
        span, _ := apm.StartSpan(c.Ctx.Request.Context(), "thingController.Get", "controller")
        span.End()
        ...
}

func main() {
        beego.Router("/", &amp;testController{})
        beego.Router("/thing/:id:int", &amp;testController{}, "get:Get")
        beego.RunWithMiddleWares("localhost:8080", apmbeego.Middleware())
}</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="builtin-modules-apmgorilla"></a>module/apmgorilla<a href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>Package apmgorilla provides middleware for the <a class="ulink" href="http://www.gorillatoolkit.org/pkg/mux" target="_top">Gorilla Mux</a> router.</p><p>For each request, a transaction is stored in the request context, which can be obtained via
<a class="ulink" href="https://golang.org/pkg/net/http/#Request" target="_top">http.Request</a><code class="literal">.Context()</code> in your handler.</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">import (
        "github.com/gorilla/mux"

        "go.elastic.co/apm/module/apmgorilla"
)

func main() {
        router := mux.NewRouter()
        router.Use(apmgorilla.Middleware())
        ...
}</pre></div><p>The apmgorilla middleware will recover panics and send them to Elastic APM, so you do not need to install any other recovery middleware.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="builtin-modules-apmgrpc"></a>module/apmgrpc<a href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>Package apmgrpc provides server and client interceptors for <a class="ulink" href="https://github.com/grpc/grpc-go" target="_top">gRPC-Go</a>.
Server interceptors report transactions for each incoming request, while client interceptors
report spans for each outgoing request. For each RPC served, a transaction is stored in the
context passed into the method.</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">import (
        "go.elastic.co/apm/module/apmgrpc"
)

func main() {
        server := grpc.NewServer(grpc.UnaryInterceptor(apmgrpc.NewUnaryServerInterceptor()))
        ...
        conn, err := grpc.Dial(addr, grpc.WithUnaryInterceptor(apmgrpc.NewUnaryClientInterceptor()))
        ...
}</pre></div><p>The server interceptor can optionally be made to recover panics, in the same way as
<a class="ulink" href="https://github.com/grpc-ecosystem/go-grpc-middleware/tree/master/recovery" target="_top">grpc_recovery</a>.
The apmgrpc server interceptor will always send panics it observes as errors to the Elastic APM server.
If you want to recover panics but also want to continue using grpc_recovery, then you should ensure
that it comes before the apmgrpc interceptor in the interceptor chain, or panics will not be captured
by apmgrpc.</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">server := grpc.NewServer(grpc.UnaryInterceptor(
        apmgrpc.NewUnaryServerInterceptor(apmgrpc.WithRecovery()),
))
...</pre></div><p>There is currently no support for intercepting at the stream level. Please file an issue and/or
send a pull request if this is something you need.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="builtin-modules-apmhttp"></a>module/apmhttp<a href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>Package apmhttp provides a low-level <code class="literal">net/http</code> middleware handler. Other web middleware should
typically be based off this.</p><p>For each request, a transaction is stored in the request context, which can be obtained via
<a class="ulink" href="https://golang.org/pkg/net/http/#Request" target="_top">http.Request</a><code class="literal">.Context()</code> in your handler.</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">import (
        "go.elastic.co/apm/module/apmhttp"
)

func main() {
        var myHandler http.Handler = ...
        tracedHandler := apmhttp.Wrap(myHandler)
}</pre></div><p>The apmhttp handler will recover panics and send them to Elastic APM.</p><p>Package apmhttp also provides functions for instrumenting an <code class="literal">http.Client</code> or <code class="literal">http.RoundTripper</code>
such that outgoing requests are traced as spans, if the request context includes a transaction.</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">import (
        "net/http"
        "golang.org/x/net/context/ctxhttp"
        "go.elastic.co/apm/module/apmhttp"
)

var tracingClient = apmhttp.WrapClient(http.DefaultClient)

func serverHandler(w http.ResponseWriter, req *http.Request) {
        resp, err := ctxhttp.Get(req.Context(), tracingClient, "http://backend.local/foo")
        ...
}

func main() {
        http.ListenAndServe(":8080", apmhttp.Wrap(http.HandlerFunc(serverHandler)))
}</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="builtin-modules-apmhttprouter"></a>module/apmhttprouter<a href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>Package apmhttprouter provides a low-level middleware handler for <a class="ulink" href="https://github.com/julienschmidt/httprouter" target="_top">httprouter</a>.</p><p>For each request, a transaction is stored in the request context, which can be obtained via
<a class="ulink" href="https://golang.org/pkg/net/http/#Request" target="_top">http.Request</a><code class="literal">.Context()</code> in your handler.</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">import (
        "github.com/julienschmidt/httprouter"

        "go.elastic.co/apm/module/apmhttprouter"
)

func main() {
        router := httprouter.New()

        const route = "/my/route"
        router.GET(route, apmhttprouter.Wrap(h, route))
        ...
}</pre></div><p><a class="ulink" href="https://github.com/julienschmidt/httprouter/pull/139" target="_top">httprouter does not provide a means of obtaining the matched route</a>, hence the route must be passed into the wrapper.</p><p>Alternatively you can use the apmhttprouter.Router type, which wraps httprouter.Router,
providing the same API and instrumenting added routes. To use this wrapper type, you
should rewrite your use of <code class="literal">httprouter.New</code> to <code class="literal">apmhttprouter.New</code>; the returned type
is <code class="literal">*apmhttprouter.Router</code>, and not <code class="literal">*httprouter.Router</code>.</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">import (
        "github.com/julienschmidt/httprouter"

        "go.elastic.co/apm/module/apmhttprouter"
)

func main() {
        router := apmhttprouter.New()

        router.GET(route, h)
        ...
}</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_module_apmlambda"></a>module/apmlambda<a href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>Package apmlambda intercepts requests to your AWS Lambda function invocations.</p><div class="warning admon"><div class="icon"><img alt="Warning" src="images/icons/warning.png" /></div><div class="admon_content"><p>This functionality is experimental and may be changed or removed completely in a future release. Elastic will take a best effort approach to fix any issues, but experimental features are not subject to the support SLA of official GA features.</p></div></div><p>Importing the package is enough to report the function invocations.</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">import (
        _ "go.elastic.co/apm/module/apmlambda"
)</pre></div><p>We currently do not expose the transactions via context; when we do, it will be
necessary to make a small change to your code to call apmlambda.Start instead of
lambda.Start.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="builtin-modules-apmsql"></a>module/apmsql<a href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>Package apmsql provides a means of wrapping <code class="literal">database/sql</code> drivers so that queries and other
executions are reported as spans within the current transaction.</p><p>To trace SQL queries, you should register drivers using apmsql.Register and obtain connections
with apmsql.Open. The parameters are exactly the same as if you were to call sql.Register
and sql.Open respectively.</p><p>As a convenience, we also provide packages which will automatically register popular drivers
with apmsql.Register:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
module/apmsql/pq (github.com/lib/pq)
</li><li class="listitem">
module/apmsql/mysql (github.com/go-sql-driver/mysql)
</li><li class="listitem">
module/apmsql/sqlite3 (github.com/mattn/go-sqlite3)
</li></ul></div><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">import (
        "go.elastic.co/apm/module/apmsql"
        _ "go.elastic.co/apm/module/apmsql/pq"
        _ "go.elastic.co/apm/module/apmsql/sqlite3"
)

func main() {
        db, err := apmsql.Open("pq", "postgres://...")
        db, err := apmsql.Open("sqlite3", ":memory:")
}</pre></div><p>Spans will be created for queries and other statement executions if the context methods are
used, and the context includes a transaction.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="builtin-modules-apmgorm"></a>module/apmgorm<a href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>Package apmgorm provides a means of instrumenting <a class="ulink" href="http://gorm.io" target="_top">GORM</a> database operations.</p><p>To trace <code class="literal">GORM</code> operations, import the appropriate <code class="literal">apmgorm/dialects</code> package (instead of the
<code class="literal">gorm/dialects</code> package), and use <code class="literal">apmgorm.Open</code> (instead of <code class="literal">gorm.Open</code>). The parameters are
exactly the same.</p><p>Once you have a <code class="literal">*gorm.DB</code> from <code class="literal">apmgorm.Open</code>, you can call <code class="literal">apmgorm.WithContext</code> to
propagate a context containing a transaction to the operations:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">import (
        "go.elastic.co/apm/module/apmgorm"
        _ "go.elastic.co/apm/module/apmgorm/dialects/postgres"
)

func main() {
        db, err := apmgorm.Open("postgres", "")
        ...
        db = apmgorm.WithContext(ctx, db)
        db.Find(...) // creates a "SELECT FROM &lt;foo&gt;" span
}</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="builtin-modules-apmgocql"></a>module/apmgocql<a href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>Package apmgocql provides a means of instrumenting <a class="ulink" href="https://github.com/gocql/gocql" target="_top">gocql</a> so
that queries are reported as spans within the current transaction.</p><p>To report <code class="literal">gocql</code> queries, you can construct an <code class="literal">apmgocql.Observer</code> and assign it to
the <code class="literal">QueryObserver</code> and <code class="literal">BatchObserver</code> fields of <code class="literal">gocql.ClusterConfig</code>, or install it
into a specific <code class="literal">gocql.Query</code> or <code class="literal">gocql.Batch</code> via their <code class="literal">Observer</code> methods.</p><p>Spans will be created for queries as long as they have context associated, and the
context includes a transaction.</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">import (
        "github.com/gocql/gocql"

        "go.elastic.co/apm/module/apmgocql"
)

func main() {
        observer := apmgocql.NewObserver()
        config := gocql.NewCluster("cassandra_host")
        config.QueryObserver = observer
        config.BatchObserver = observer

        session, err := config.CreateSession()
        ...
        err = session.Query("SELECT * FROM foo").WithContext(ctx).Exec()
        ...
}</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="builtin-modules-apmredigo"></a>module/apmredigo<a href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>Package apmredigo provides a means of instrumenting <a class="ulink" href="https://github.com/gomodule/redigo" target="_top">Redigo</a>
so that Redis commands are reported as spans within the current transaction.</p><p>To report Redis commands, you can use the top-level <code class="literal">Do</code> or <code class="literal">DoWithTimeout</code> functions.
These functions have the same signature as the <code class="literal">redis.Conn</code> equivalents apart from an
initial <code class="literal">context.Context</code> parameter. If the context passed in contains a sampled
transaction, a span will be reported for the Redis command.</p><p>Another top-level function, <code class="literal">Wrap</code>, is provided to wrap a <code class="literal">redis.Conn</code> such that its
<code class="literal">Do</code> and <code class="literal">DoWithTimeout</code> methods call the above mentioned functions. Initially, the
wrapped connection will be associated with the background context; its <code class="literal">WithContext</code>
method may be used to obtain a shallow copy with another context. For example, in an
HTTP middleware you might bind a connection to the request context, which would
associate spans with the request’s APM transaction.</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">import (
        "net/http"

        "github.com/gomodule/redigo/redis"

        "go.elastic.co/apm/module/apmredigo"
)

var redisPool *redis.Pool // initialized at program startup

func handleRequest(w http.ResponseWriter, req *http.Request) {
        // Wrap and bind redis.Conn to request context. If the HTTP
        // server is instrumented with Elastic APM (e.g. with apmhttp),
        // Redis commands will be reported as spans within the request's
        // transaction.
        conn := apmredigo.Wrap(redisPool.Get()).WithContext(req.Context())
        defer conn.Close()
        ...
}</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="builtin-modules-apmrestful"></a>module/apmrestful<a href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>Package apmrestful provides a <a class="ulink" href="https://github.com/emicklei/go-restful" target="_top">go-restful</a> filter
for tracing requests, and capturing panics.</p><p>For each request, a transaction is stored in the request context, which can be obtained via
<a class="ulink" href="https://golang.org/pkg/net/http/#Request" target="_top">http.Request</a><code class="literal">.Context()</code> in your handler.</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">import (
        "github.com/emicklei/go-restful"

        "go.elastic.co/apm/module/apmrestful"
)

func init() {
        // Trace all requests to web services registered with the default container.
        restful.Filter(apmrestful.Filter())
}

func main() {
        var ws restful.WebService
        ws.Path("/things").Consumes(restful.MIME_JSON, restful.MIME_XML).Produces(restful.MIME_JSON, restful.MIME_XML)
        ws.Route(ws.GET("/{id:[0-1]+}").To(func(req *restful.Request, resp *restful.Response) {
                // req.Request.Context() should be propagated to downstream operations such as database queries.
        }))
        ...
}</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="builtin-modules-apmlogrus"></a>module/apmlogrus<a href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>Package apmlogrus provides a <a class="ulink" href="https://github.com/sirupsen/logrus" target="_top">logrus</a> Hook
implementation for sending error messages to Elastic APM, as well as a function
for adding trace context fields to log records.</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">import (
        "github.com/sirupsen/logrus"

        "go.elastic.co/apm/module/apmlogrus"
)

func init() {
        // apmlogrus.Hook will send "error", "panic", and "fatal" level log messages to Elastic APM.
        logrus.AddHook(&amp;apmlogrus.Hook{})
}

func handleRequest(w http.ResponseWriter, req *http.Request) {
        // apmlogrus.TraceContext extracts the transaction and span (if any) from the given context,
        // and returns logrus.Fields containing the trace, transaction, and span IDs.
        traceContextFields := apmlogrus.TraceContext(req.Context())
        logrus.WithFields(traceContextFields).Debug("handling request")

        // Output:
        // {"level":"debug","msg":"handling request","time":"1970-01-01T00:00:00Z","trace.id":"67829ae467e896fb2b87ec2de50f6c0e","transaction.id":"67829ae467e896fb"}
}</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="builtin-modules-apmzap"></a>module/apmzap<a href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>Package apmzap provides a <a class="ulink" href="https://godoc.org/go.uber.org/zap/zapcore#Core" target="_top">go.uber.org/zap/zapcore.Core</a>
implementation for sending error messages to Elastic APM, as well as a function
for adding trace context fields to log records.</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">import (
        "go.uber.org/zap"

        "go.elastic.co/apm/module/apmzap"
)

// apmzap.Core.WrapCore will wrap the core created by zap.NewExample
// such that logs are also sent to the apmzap.Core.
//
// apmzap.Core will send "error", "panic", and "fatal" level log
// messages to Elastic APM.
var logger = zap.NewExample(zap.WrapCore((&amp;apmzap.Core{}).WrapCore))

func handleRequest(w http.ResponseWriter, req *http.Request) {
        // apmzap.TraceContext extracts the transaction and span (if any)
        // from the given context, and returns zap.Fields containing the
        // trace, transaction, and span IDs.
        traceContextFields := apmzap.TraceContext(req.Context())
        logger.With(traceContextFields...).Debug("handling request")

        // Output:
        // {"level":"debug","msg":"handling request","trace.id":"67829ae467e896fb2b87ec2de50f6c0e","transaction.id":"67829ae467e896fb"}
}</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="custom-instrumentation"></a>Custom instrumentation<a href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>To report on the performance of transactions served by your application, you can use the Go
agent’s <a class="link" href="api.html" title="API Documentation">API</a>. Instrumentation refers to modifying your application code to report:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
transactions
</li><li class="listitem">
spans within transactions
</li><li class="listitem">
errors
</li></ul></div><p>A transaction represents a top-level operation in your application, such as an HTTP or RPC
request. A span represents an operation within a transaction, such as a database query, or
a request to another service. Errors may refer to Go errors, or panics.</p><p>To report these things, you will use a <a class="link" href="api.html#tracer-api" title="Tracer APIedit">apm.Tracer</a> — typically
<code class="literal">apm.DefaultTracer</code>, which is configured via environment variables. In the code
examples below we will refer to <code class="literal">apm.DefaultTracer</code>. Please refer to the <a class="link" href="api.html" title="API Documentation">API documentation</a>
for a more thorough description of the types and methods.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_transactions"></a>Transactions<a href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>To report a transaction, you call <a class="link" href="api.html#tracer-api-start-transaction" title="func (*Tracer) StartTransaction(name, type string) *Transactionedit">apm.DefaultTracer.StartTransaction</a>
with the transaction name and type. This returns a <code class="literal">Transaction</code> object; the transaction
can be customized with additional context before you call its <code class="literal">End</code> method to indicate
that the transaction has completed. Once the transaction’s <code class="literal">End</code> method is called, it
will be enqueued for sending to the Elastic APM server, and made available to the APM UI.</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">tx := apm.DefaultTracer.StartTransaction("GET /api/v1", "request")
defer tx.End()
...
tx.Result = "HTTP 2xx"
tx.Context.SetTag("region", "us-east-1")</pre></div><p>The agent supports sampling transactions: non-sampled transactions will be still be
reported, but with limited context and without any spans. To determine whether a
transaction is sampled, use the <code class="literal">Transaction.Sampled</code> method; if it returns false,
you should avoid unnecessary storage or processing required for setting transaction
context.</p><p>Once you have started a transaction, you can include it in a <code class="literal">context</code> object for
propagating throughout the application. See <a class="link" href="instrumenting-source.html#custom-instrumentation-propagation" title="Context propagation">context propagation</a>
for more details.</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">ctx = apm.ContextWithTransaction(ctx, tx)</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="custom-instrumentation-spans"></a>Spans<a href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>To report an operation within a transaction, you should use <a class="link" href="api.html#transaction-start-span" title="func (*Transaction) StartSpan(name, spanType string, parent *Span) *Spanedit">Transaction.StartSpan</a>
or <a class="link" href="api.html#apm-start-span" title="func StartSpan(ctx context.Context, name, spanType string) (*Span, context.Context)edit">apm.StartSpan</a> to start a span given a transaction or a <code class="literal">context</code>
containing a transaction, respectively. Like a transaction, a span has a name and a type. In addition,
a span can have a parent span within the same transaction. If the context provided to <code class="literal">apm.StartSpan</code>
contains a span, then that will be considered the parent. See <a class="link" href="instrumenting-source.html#custom-instrumentation-propagation" title="Context propagation">context propagation</a>
for more details.</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">span, ctx := apm.StartSpan(ctx, "SELECT FROM foo", "db.mysql.query")
defer span.End()</pre></div><p><code class="literal">Transaction.StartSpan</code> and <code class="literal">apm.StartSpan</code> will always return a non-nil <code class="literal">Span</code>, even if the
transaction is nil. It is always safe to defer a call to the span’s End method. If setting the span’s
context would incur significant overhead, you may want to check if the span is dropped first, by calling
the <code class="literal">Span.Dropped</code> method.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="custom-instrumentation-propagation"></a>Context propagation<a href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>In Go, <a class="ulink" href="https://golang.org/pkg/context/" target="_top">context</a> is used to propagate request-scoped values along a call
chain, potentially crossing between goroutines and between processes. For servers based on <code class="literal">net/http</code>,
each request contains an independent context object, which allows adding values specific to that particular
request.</p><p>When you start a transaction, you can add it to a context object using
<a class="link" href="api.html#apm-context-with-transaction" title="func ContextWithTransaction(context.Context, *Transaction) context.Contextedit">apm.ContextWithTransaction</a>. This context object can be
later passed to <a class="link" href="api.html#apm-transaction-from-context" title="func TransactionFromContext(context.Context) *Transactionedit">apm.TransactionFromContext</a> to obtain
the transaction, or into <a class="link" href="api.html#apm-start-span" title="func StartSpan(ctx context.Context, name, spanType string) (*Span, context.Context)edit">apm.StartSpan</a> to start a span.</p><p>The simplest way to create and propagate a span is by using <a class="link" href="api.html#apm-start-span" title="func StartSpan(ctx context.Context, name, spanType string) (*Span, context.Context)edit">apm.StartSpan</a>,
which takes a context and returns a span. The span will be created as a child of the span most recently
added to this context, or a transaction added to the context as described above. If the context contains
neither a transaction nor a span, then the span will be dropped (i.e. will not be reported to the APM Server.)</p><p>For example, take a simple CRUD-type web service, which accepts requests over HTTP and then makes
corresponding database queries. For each incoming request, a transaction will be started and added to the
request context automatically. This context needs to be passed into method calls within the handler manually
in order to create spans within that transaction, e.g. to measure the duration of SQL queries.</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">import (
        "net/http"

        "go.elastic.co/apm"
        "go.elastic.co/apm/module/apmhttp"
        "go.elastic.co/apm/module/apmsql"
        _ "go.elastic.co/apm/module/apmsql/pq"
)

var db *sql.DB

func init() {
        // apmsql.Open wraps sql.Open, in order
        // to add tracing to database operations.
        db, _ = apmsql.Open("postgres", "")
}

func main() {
        mux := http.NewServeMux()
        mux.HandleFunc("/", handleList)

        // apmhttp.Wrap instruments an http.Handler, in order
        // to report any request to this handler as a transaction,
        // and to store the transaction in the request's context.
        handler := apmhttp.Wrap(mux)
        http.ListenAndServe(":8080", handler)
}

func handleList(w http.ResponseWriter, req *http.Request) {
        // By passing the request context down to getList, getList can add spans to it.
        ctx := req.Context()
        getList(ctx)
        ...
}

func getList(ctx context.Context) (
        // When getList is called with a context containing a transaction or span,
        // StartSpan creates a child span. In this example, getList is always called
        // with a context containing a transaction for the handler, so we should
        // expect to see something like:
        //
        //     Transaction: handleList
        //         Span: getList
        //             Span: SELECT FROM items
        //
        span, ctx := apm.StartSpan(ctx, "getList", "custom")
        defer span.End()

        // NOTE: The context object ctx returned by StartSpan above contains
        // the current span now, so subsequent calls to StartSpan create new
        // child spans.

        // db was opened with apmsql, so queries will be reported as
        // spans when using the context methods.
        rows, err := db.QueryContext(ctx, "SELECT * FROM items")
        ...
        rows.Close()
}</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_panic_recovery_and_errors"></a>Panic recovery and errors<a href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>If you want to recover panics, and report them along with your transaction, you can use the
<a class="link" href="api.html#tracer-recovered" title="func (*Tracer) Recovered(interface{}) *Erroredit">Tracer.Recovered</a> method in a recovery function. There are also methods for reporting
non-panic errors: <a class="link" href="api.html#tracer-new-error" title="func (*Tracer) NewError(error) *Erroredit">Tracer.NewError</a>, <a class="link" href="api.html#tracer-new-error-log" title="func (*Tracer) NewErrorLog(ErrorLogRecord) *Erroredit">Tracer.NewErrorLog</a>, and
<a class="link" href="api.html#apm-captureerror" title="func CaptureError(context.Context, error) *Erroredit">apm.CaptureError</a>.</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-go">defer func() {
        if v := recover(); v != nil {
                e := apm.DefaultTracer.Recovered()
                e.SetTransaction(tx) // or e.SetSpan(span)
                e.Send()
        }
}()</pre></div><p>See the <a class="link" href="api.html#error-api" title="Errorsedit">Error API</a> for details and examples of the other methods.</p></div></div></div><div class="navfooter"><span class="prev"><a href="installation.html">
              « 
              Installation</a>
           
        </span><span class="next">
           
          <a href="configuration.html">Configuration
               »
            </a></span></div>
<!-- end body -->

            </div>
            <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
        
					<div id="rtpcontainer" style="display: block;">
						<div class="mktg-promo">
						<h3>Getting Started Videos</h3>
						<ul class="icons">
							<li class="icon-elasticsearch-white"><a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">Starting Elasticsearch</a></li>
							<li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Introduction to Kibana</a></li>
							<li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/getting-started-logstash?baymax=default&elektra=docs&storm=top-video">Logstash Starter Guide</a></li>
						</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>

        </div>
      	


<div id="footer-subscribe" class="home-footer-subscribe">
  <div class="subscribe-wrapper">
    <div class="container">
      <div class="subscribe-form-container">
        <div class="subscribe-title col-md-12 col-lg-6">
            <h5>Be in the know with the latest and greatest from Elastic.</h5>
        </div>
        <div class="subscribe-form col-md-12 col-lg-6">
          <form class="mktoForm sb-form"></form>
        </div>
      </div>
      <div class="form_thanks hide">
        
          <p>Thanks for subscribing! We'll keep you updated with new releases.</p>
        
      </div>
    </div>
  </div>
</div>
<!--subscribe newsletter end-->

<!-- Footer Section -->
<footer class="footer-wrapper">
  <div class="container">
    <div class="row footer-content">
        
          <div class="col-xs-6 col-sm-3 col-md-3">
              
                <h3><a href="/products">Products ></a></h3>
              
              
              
              <ul class="">
              
                
                  
                    <li><a href="/products/elasticsearch">Elasticsearch</a></li>
                  
                
              
                
                  
                    <li><a href="/products/kibana">Kibana</a></li>
                  
                
              
                
                  
                    <li><a href="/products/beats">Beats</a></li>
                  
                
              
                
                  
                    <li><a href="/products/logstash">Logstash</a></li>
                  
                
              
                
                  
                    <li><a href="/products/stack">Stack Features (formerly X-Pack)</a></li>
                  
                
              
                
                  
                    <li><a href="/products/stack/security">Security</a></li>
                  
                
              
                
                  
                    <li><a href="/products/stack/alerting">Alerting</a></li>
                  
                
              
                
                  
                    <li><a href="/products/stack/canvas">Canvas</a></li>
                  
                
              
                
                  
                    <li><a href="/products/stack/monitoring">Monitoring</a></li>
                  
                
              
                
                  
                    <li><a href="/products/stack/graph">Graph</a></li>
                  
                
              
                
                  
                    <li><a href="/products/stack/reporting">Reporting</a></li>
                  
                
              
                
                  
                    <li><a href="/products/stack/machine-learning">Machine Learning</a></li>
                  
                
              
                
                  
                    <li><a href="/products/stack/elasticsearch-sql">Elasticsearch SQL</a></li>
                  
                
              
                
                  
                    <li><a href="/products/hadoop">Elasticsearch-Hadoop</a></li>
                  
                
              
                
                  
                    <li><a href="/products/ece">Elastic Cloud Enterprise</a></li>
                  
                
              
              </ul>
              
                <h3><a href=""></a></h3>
              
              
              
              <ul class="">
              
              </ul>
          </div>    
      
          <div class="col-xs-6 col-sm-3 col-md-3">
              
                <h3><a href="/solutions">Solutions ></a></h3>
              
              
              
              <ul class="">
              
                
                  
                    <li><a href="/solutions/logging">Logging</a></li>
                  
                
              
                
                  
                    <li><a href="/solutions/metrics">Metrics</a></li>
                  
                
              
                
                  
                    <li><a href="/solutions/site-search">Site Search</a></li>
                  
                
              
                
                  
                    <li><a href="/solutions/security-analytics">Security Analytics</a></li>
                  
                
              
                
                  
                    <li><a href="/solutions/apm">APM</a></li>
                  
                
              
                
                  
                    <li><a href="/solutions/app-search">App Search</a></li>
                  
                
              
              </ul>
              
                <h3><a href="/cloud">Elastic Cloud ></a></h3>
              
              
              
              <ul class="">
              
                
                  
                    <li><a href="/cloud/elasticsearch-service">Elasticsearch Service</a></li>
                  
                
              
                
                  
                    <li><a href="/aws-elasticsearch-service">AWS Elasticsearch Service Comparison</a></li>
                  
                
              
                
                  
                    <li><a href="/cloud/app-search-service">Elastic App Search Service</a></li>
                  
                
              
                
                  
                    <li><a href="/cloud/site-search-service">Elastic Site Search Service</a></li>
                  
                
              
              </ul>
          </div>    
      
          <div class="col-xs-6 col-sm-3 col-md-3">
              
                <h3>Resources</h3>
              
              
              
              <ul class="">
              
                
                  
                    <li><a href="/blog">Blog</a></li>
                  
                
              
                
                  
                    <li><a href="https://cloud-status.elastic.co">Cloud Status</a></li>
                  
                
              
                
                  
                    <li><a href="/community">Community</a></li>
                  
                
              
                
                  
                    <li><a href="/use-cases">Customers & Use Cases</a></li>
                  
                
              
                
                  
                    <li><a href="/guide">Documentation</a></li>
                  
                
              
                
                  
                    <li><a href="/elasticon">Elastic{ON} Events</a></li>
                  
                
              
                
                  
                    <li><a href="https://discuss.elastic.co/">Forums</a></li>
                  
                
              
                
                  
                    <li><a href="/community/meetups">Meetups</a></li>
                  
                
              
                
                  
                    <li><a href="/subscriptions">Subscriptions</a></li>
                  
                
              
                
                  
                    <li><a href="https://support.elastic.co">Support Portal</a></li>
                  
                
              
                
                  
                    <li><a href="/videos">Videos & Webinars</a></li>
                  
                
              
                
                  
                    <li><a href="/training">Training</a></li>
                  
                
              
              </ul>
              
                <h3></h3>
              
              
              
              <ul class="">
              
              </ul>
          </div>    
      
          <div class="col-xs-6 col-sm-3 col-md-3">
              
                <h3><a href="/about">About ></a></h3>
              
              
              
              <ul class="">
              
                
                  
                    <li><a href="/about/careers">Careers/Jobs</a></li>
                  
                
              
                
                  
                    <li><a href="/about/our-source-code">Our Source Code</a></li>
                  
                
              
                
                  
                    <li><a href="/about/teams">Teams</a></li>
                  
                
              
                
                  
                    <li><a href="/about/teams/board">Board of Directors</a></li>
                  
                
              
                
                  
                    <li><a href="/about/teams/leadership">Leadership</a></li>
                  
                
              
                
                  
                    <li><a href="/contact">Contact</a></li>
                  
                
              
                
                  
                    <li><a href="/about/history-of-elasticsearch">Our Story</a></li>
                  
                
              
                
                  
                    <li><a href="/about/why-open-source">Why Open Source</a></li>
                  
                
              
                
                  
                    <li><a href="/about/distributed">Distributed by Intention</a></li>
                  
                
              
                
                  
                    <li><a href="/about/partners">Partners</a></li>
                  
                
              
                
                  
                    <li><a href="/about/press">Media</a></li>
                  
                
              
                
                  
                    <li><a href="https://ir.elastic.co">Investor Relations</a></li>
                  
                
              
                
                  
                    <li><a href="https://www.elastic.shop">Elastic Store</a></li>
                  
                
              
              </ul>
              
                <h3><a href=""></a></h3>
              
              
              
              <ul class="">
              
              </ul>
          </div>    
       
    </div>
     <!-- Social Media Section -->
    <div class="row social-icon">
      <div class="col-xs-12 col-sm-12 col-md-6 col-md-offset-3">
	    <div class="row">
		     <div class="follow-us col-xs-12 col-sm-12 col-md-12">
			    <div class="social-label">FOLLOW US</div>
			    <ul class="social-icon-list">
          
          		 	<li class="Facebook"><a id="footer_facebook" href="https://www.facebook.com/elastic.co">Facebook</a></li>
          
          		 	<li class="Twitter"><a id="footer_twitter" href="https://www.twitter.com/elastic">Twitter</a></li>
          
          		 	<li class="LinkedIn"><a id="footer_linkedin" href="https://www.linkedin.com/company/elastic-co">LinkedIn</a></li>
          
          		 	<li class="Xing"><a id="footer_xing" href="https://www.xing.com/companies/elastic.co">Xing</a></li>
          
          		 	<li class="YouTube"><a id="footer_youtube" href="https://www.youtube.com/user/elasticsearch">YouTube</a></li>
          
		  		</ul>
		     </div>
	    </div>
      </div>
    </div>
    <!-- Social Media Section end-->
    <div class="row">
	<div class="col-xs-12 col-sm-12 col-md-11">
		<div class="copyright">
			<ul>
				<li><a href="/legal/trademarks">Trademarks</a></li>
				<li><a href="/legal/terms-of-use">Terms of Use</a></li>
				<li><a href="/legal/privacy-statement">Privacy</a></li>
				<li><a href="/brand">Brand</a></li>
			</ul>
			<div class="copyright-content">
				<div class="footer-text">
					<p>© 2019. Elasticsearch B.V. All Rights Reserved
					</p>
					<p>Elasticsearch is a trademark of Elasticsearch B.V., registered in the U.S. and in other countries.
					</p>
					<p>Apache, Apache Lucene, Apache Hadoop, Hadoop, HDFS and the yellow elephant logo are trademarks of the <a href="http://www.apache.org/">Apache Software Foundation</a> in the United States and/or other countries.
					</p>
				</div>
			</div>
		</div>
	</div>
	<div class="col-xs-2 col-xs-offset-5 col-sm-1 col-sm-offset-5 col-md-1 col-md-offset-0">
		<div class="footer-logo"><a href="/"><img src="/static/images/svg/logo-elastic-footer-stacked-999.svg" class="img-responsive"></a>
		</div>
	</div>
</div>
  </div>
</footer>
<!-- Footer Section end-->

<style type="text/css">
	
        
            .Facebook a {background:url("/assets/bltf546ff2e0a8f2de5/facebook.svg") no-repeat;}
            .Facebook a:before {
                content: url("/assets/bltc24cf11c714ecfc4/facebook-hover.svg");
                width:0;
                height:0;
                visibility:hidden;
            }
        
        
            .Facebook a:hover {background:url("/assets/bltc24cf11c714ecfc4/facebook-hover.svg")}		
        
	
        
            .Twitter a {background:url("/assets/bltdd9556d6b24e2b85/twitter.svg") no-repeat;}
            .Twitter a:before {
                content: url("/assets/blt90b0372cc07a54d3/twitter-hover.svg");
                width:0;
                height:0;
                visibility:hidden;
            }
        
        
            .Twitter a:hover {background:url("/assets/blt90b0372cc07a54d3/twitter-hover.svg")}		
        
	
        
            .LinkedIn a {background:url("/assets/bltc4a77e0f52ce07f1/linkedin.svg") no-repeat;}
            .LinkedIn a:before {
                content: url("/assets/blt01ce654380e4ea6c/linkedin-hover.svg");
                width:0;
                height:0;
                visibility:hidden;
            }
        
        
            .LinkedIn a:hover {background:url("/assets/blt01ce654380e4ea6c/linkedin-hover.svg")}		
        
	
        
            .Xing a {background:url("/assets/bltc6347078dcc9ec76/xing.svg") no-repeat;}
            .Xing a:before {
                content: url("/assets/bltededebe5f7521a39/xing-hover.svg");
                width:0;
                height:0;
                visibility:hidden;
            }
        
        
            .Xing a:hover {background:url("/assets/bltededebe5f7521a39/xing-hover.svg")}		
        
	
        
            .YouTube a {background:url("/assets/blt4982061ce1aebc7f/youtube.svg") no-repeat;}
            .YouTube a:before {
                content: url("/assets/bltddeb6c6404ae81a5/youtube-hover.svg");
                width:0;
                height:0;
                visibility:hidden;
            }
        
        
            .YouTube a:hover {background:url("/assets/bltddeb6c6404ae81a5/youtube-hover.svg")}		
        
	
</style>

<script src="//app-lon02.marketo.com/js/forms2/js/forms2.min.js"></script>
<script>
$(document).ready(function(){

    var ipSuccess = function(data) {
        country = data.country_code;
        if (data.in_eu){
                        
            marketo_id = "6196";
            
        }else{ 
            marketo_id = "1398";

        }

        $('.subscribe-form form.sb-form').attr('id', 'mktoForm_' + marketo_id);
        if(window.MktoForms2){
            MktoForms2.loadForm("//app-lon02.marketo.com", "813-MAM-392", marketo_id,function(form){
                form.onSuccess(function(form){
                    $('#mktoForm_'+marketo_id).css('display','none');
                    $('.subscribe-wrapper .subscribe-form-container').hide();
                    $('.subscribe-wrapper').find('.form_thanks').removeClass('hide')
                    dataLayer.push({'event': 'mktoFormSubmit'});
                    return false;
                });
            });  
        }
    }

    var marketo_id;

    $.ajax({
        url: "/gdpr-data"
    }).success(function(data) {
        ipSuccess(data);
    });

})
</script>

      </section>
    </div>

    
     <script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script src="/static/js/jquery.autocomplete.js"></script>
<script type="text/javascript" src="/static/js/slick.min.js"></script>
<script src="/static/js/nav-v5.js"></script>
<script src="/static/js/script.js"></script>
 
     
<script type="text/javascript">
$(document).ready(function(){
	if (window.location.hash.length) {
	      var target = $(window.location.hash);
	      target = target.length ? target : $(window.location.hash);
	      if (target.length) {
	        setTimeout(function(){ $(window).scrollTop(target.offset().top - 60); }, 1200);        
	      }
	}
	$('#guide').on('click','a[href*=#]:not([href=#])',function(e) {
			var flag=true;
		      if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'') && location.hostname == this.hostname) {
		          var target = $(this.hash);
		          target = target.length ? target :$(this.hash);
		          if (target.length) {
		            if(flag){
		              flag=false;
		              var heightScroll=($('.tertiary-nav.navbar-fixed-top').height())?60:110;
		              $('html,body').animate({
		                  scrollTop: target.offset().top - heightScroll
		                }, 2000, function(){
		                  flag=true;
		                });
		            }                    
		          }
		      }
		    
	});

})

</script>

     <style></style>
     
  
            <script type="text/javascript" src="docs.js"></script>
<script type='text/javascript' src='https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js?lang=yaml'></script>

            </body>
        
</html>