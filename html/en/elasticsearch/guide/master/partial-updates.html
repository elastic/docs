<!DOCTYPE html>
<html lang="en-us">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Partial Updates to Documents
        | Elasticsearch: The Definitive Guide [master]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch: The Definitive Guide [master]" /><link rel="up" href="data-in-data-out.html" title="Data In, Data Out" /><link rel="prev" href="optimistic-concurrency-control.html" title="Optimistic Concurrency Control" /><link rel="next" href="_retrieving_multiple_documents.html" title="Retrieving Multiple Documents" /><meta name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta name="DC.type" content="Docs/Elasticsearch/Definitive Guide/master" />
  	
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- RTP tag -->
    <script type='text/javascript' async>
    (function(c,h,a,f,i,e){c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
     c[a].a=i;c[a].e=e;var g=h.createElement("script");g.async=true;g.type="text/javascript";
     g.src=f+'?aid='+i;var b=h.getElementsByTagName("script")[0];b.parentNode.insertBefore(g,b);
     })(window,document,"rtp","//sjrtp2-cdn.marketo.com/rtp-api/v1/rtp.js","elasticco");

    rtp('send','view');
    rtp('get', 'campaign',true);
    </script>
    <!-- End of RTP tag -->
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#ffffff">
<meta name="apple-mobile-web-app-title" content="Elastic">
<meta name="application-name" content="Elastic">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/mstile-144x144.png">
<meta name="theme-color" content="#ffffff">
<!-- DC tags section -->
<link rel="schema.DC" href="http://purl.org/dc/elements/1.1/" >
<link rel="schema.DCTERMS" href="http://purl.org/dc/terms/" >


<!-- end DC tags -->


	<meta name="description" content="" />





	<meta property="og:image" content="/static/img/cluster-small.png" />

		

    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <!-- For third-generation iPad with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <!-- For iPhone with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <!-- For first- and second-generation iPad: -->
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">

	   

    <!-- css -->
    <link href="https://static-www.elastic.co/static/css/main.css?q=200" rel="stylesheet">
    
    

    <script src="https://static-www.elastic.co/static/js/jquery.min.js?q=200"></script>
    <script src="https://static-www.elastic.co/static/js/bootstrap.min.js?q=200"></script>
    <script src="https://static-www.elastic.co/static/js/jquery.cookie.js?q=200"></script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script type="text/javascript">
      // ---------------------------- set language based on browser language --------------------
      var lang = '/'+(navigator.language || navigator.userLanguage).slice(0,2)+'/',
        locales = {
          '/en/': '/',
          '/de/': '/de/',
          '/fr/': '/fr/',
          '/ja/':'/jp/',
          '/ko/':'/kr/'
        }
        localepages = ['/','/de/','/fr/','/jp/','/kr/','/products','/de/products','/fr/products','/jp/products','/kr/products'],
        locationpath = window.location.pathname,
        localeUrl = '{"relative_url_prefix":"/","code":"en-us","url":"/guide_template"}',
        currentlocale = JSON.parse(localeUrl);
    
      if(localepages.indexOf(locationpath) != -1){
        if($.cookie("c_lang")){
          if($.cookie("c_lang") != currentlocale.relative_url_prefix){
            var cookieurl = $.cookie("c_lang") + currentlocale.url.slice(1,currentlocale.url.length);
            window.location = cookieurl;
          }
        }
        else{
          var locale_lang = "/";
          if(locales[lang] != undefined){
            locale_lang = locales[lang];
          }
          $.cookie("c_lang",locale_lang ,{ expires: 365, path: '/'}); 
          window.location = localepages[localepages.indexOf(locationpath)];
        }
      }
      
      // --------------------- end of set language based on browser language -----------------
      </script>


	
	<link type="text/css" rel="stylesheet" href="https://static-www.elastic.co/static/css/guide.css?q=200" />


  
<link rel="stylesheet" type="text/css" href="styles.css" />

</head>
  <body >
  	<!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5"
                              height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- begin olark code -->
    <script data-cfasync="false" type='text/javascript'>/*<![CDATA[*/window.olark||(function(c){var f=window,d=document,l=f.location.protocol=="https:"?"https:":"http:",z=c.name,r="load";var nt=function(){
    f[z]=function(){
    (a.s=a.s||[]).push(arguments)};var a=f[z]._={
    },q=c.methods.length;while(q--){(function(n){f[z][n]=function(){
    f[z]("call",n,arguments)}})(c.methods[q])}a.l=c.loader;a.i=nt;a.p={
    0:+new Date};a.P=function(u){
    a.p[u]=new Date-a.p[0]};function s(){
    a.P(r);f[z](r)}f.addEventListener?f.addEventListener(r,s,false):f.attachEvent("on"+r,s);var ld=function(){function p(hd){
    hd="head";return["<",hd,"></",hd,"><",i,' onl' + 'oad="var d=',g,";d.getElementsByTagName('head')[0].",j,"(d.",h,"('script')).",k,"='",l,"//",a.l,"'",'"',"></",i,">"].join("")}var i="body",m=d[i];if(!m){
    return setTimeout(ld,100)}a.P(1);var j="appendChild",h="createElement",k="src",n=d[h]("div"),v=n[j](d[h](z)),b=d[h]("iframe"),g="document",e="domain",o;n.style.display="none";m.insertBefore(n,m.firstChild).id=z;b.frameBorder="0";b.id=z+"-loader";if(/MSIE[ ]+6/.test(navigator.userAgent)){
    b.src="javascript:false"}b.allowTransparency="true";v[j](b);try{
    b.contentWindow[g].open()}catch(w){
    c[e]=d[e];o="javascript:var d="+g+".open();d.domain='"+d.domain+"';";b[k]=o+"void(0);"}try{
    var t=b.contentWindow[g];t.write(p());t.close()}catch(x){
    b[k]=o+'d.write("'+p().replace(/"/g,String.fromCharCode(92)+'"')+'");d.close();'}a.P(2)};ld()};nt()})({
    loader: "static.olark.com/jsclient/loader0.js",name:"olark",methods:["configure","extend","declare","identify"]});
    /* custom configuration goes here (www.olark.com/documentation) */
    olark.identify('1356-750-10-5709');/*]]>*/</script><noscript><a href="https://www.olark.com/site/1356-750-10-5709/contact" title="Contact us">Questions? Feedback?</a> powered by <a href="http://www.olark.com?welcome" title="Olark live chat software">Olark live chat software</a></noscript>
    <!-- end olark code -->

    <script> 
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ 
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), 
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) 
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); 
      ga('create', 'UA-12395217-16', 'auto'); 
      ga('send', 'pageview'); 
    </script>

    <!-- Header Section -->
    
<header class="header-wrapper">
   

  




<div class="navigation-wrapper">
  <div class="container">
    <nav class="navbar">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-mobile-header navbar-header mr-20 mr-xs-0">
      <div class="row hidden-sm hidden-md hidden-lg">
        <div class="col-xs-5 hidden-sm hidden-md hidden-lg">
          <div class="navbar-mobile-header-icon navbar-mobile-header-icon-out">
            <span></span>
            <span></span>
            <span></span>
          </div>
          
            <a href="/learn" class="nav-title hidden-sm hidden-md hidden-lg m-l-8">Learn</a>
          
        </div>
        <div class="col-xs-2 text-center">
          <div class="navbar-brand" id="elastic">
            <h1>
              <a class="logo-m hidden-sm hidden-md hidden-lg" href="/">
                <img src="https://static-www.elastic.co/assets/bltd5ac38b4549d53de/elastic-logo-mobile (1).svg?q=200" alt="elastic-logo-mobile">
              </a>
            </h1>
          </div>
        </div>
        <div class="col-xs-5 hidden-sm hidden-md hidden-lg text-right">
          <ul class="menu-m hidden-sm hidden-md hidden-lg">
            <li class=""><a class="icon-contact" href="/contact"></a></li>
            <li id="searchbar"><a class="button icon" href="#"></a></li>
            <li class="lang global-language">
                
                  <a href="#">EN</a>
                
              <ul class="language-list">
                
                  
                    
                  
                <li><a href="/" data-value="/" id="locale-select">English</a></li>
                
                  
                    
                  
                <li><a href="/fr/" data-value="/fr/" id="locale-select">Français</a></li>
                
                  
                    
                  
                <li><a href="/de/" data-value="/de/" id="locale-select">Deutsch</a></li>
                
                  
                    
                  
                <li><a href="/jp/" data-value="/jp/" id="locale-select">日本語</a></li>
                
                  
                    
                  
                <li><a href="/kr/" data-value="/kr/" id="locale-select">한국어</a></li>
                
              </ul>
            </li>
          </ul>
        </div>
      </div>

      <div class="navbar-brand hidden-xs" id="elastic">
        <h1>
          <a class="hidden-xs" id="elastic-logo" href="/">
            <img src="https://static-www.elastic.co/assets/blt6050efb80ceabd47/elastic-logo (2).svg?q=200" alt="elastic-logo">
          </a>
        </h1>
      </div>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse mobile-inner-nav">
      <nav class="nav navbar-nav primary-nav-hover" id="nav">
        <ul>
        
          
            
              
            
            <li>
              <a id="nav_products" class=" " href="/products">Products</a>
            </li>
          
        
          
            
              
            
            <li>
              <a id="nav_cloud" class=" " href="/cloud">Cloud</a>
            </li>
          
        
          
            
              
            
            <li>
              <a id="nav_services" class=" " href="/services">Services</a>
            </li>
          
        
          
            
              
            
            <li>
              <a id="nav_customers" class=" " href="/use-cases">Customers</a>
            </li>
          
        
          
            
              
            
            <li>
              <a id="nav_learn" class="active" href="/learn">Learn</a>
            </li>
          
        
          
        
        </ul>
      </nav>
      <nav class="nav navbar-nav navbar-right hidden-xs">
        <ul>
          <li class="hidden-xs hidden-sm"><a href="/downloads">downloads</a></li>
          <li class="hidden-xs hidden-md hidden-lg"><a class="icon-download" href="/downloads"></a></li>
          <!-- To set parameters to contact button -->
          
           
            
          

          
            
            
          
          <li class="hidden-xs hidden-sm"><a class="btn btn-secondary btn-contact" href="/contact?storm=global-header-en">contact</a></li>
          <!-- ////////////////ends here///////////////-->          
          <li class="hidden-xs hidden-md hidden-lg"><a class="icon-contact" href="/contact?storm=global-header-en"></a></li>
          <li class="hidden-xs" id="searchbar"><a class="button icon" href="#"></a></li>
          <li class="hidden-xs lang global-language">
                
                  <a href="#">EN</a>
                
               <ul class="language-list">
              
                
                  
                
              <li><a class="" href="/" data-value="/">English</a></li>
              
                
                  
                
              <li><a class="" href="/fr/" data-value="/fr/">Français</a></li>
              
                
                  
                
              <li><a class="" href="/de/" data-value="/de/">Deutsch</a></li>
              
                
                  
                
              <li><a class="" href="/jp/" data-value="/jp/">日本語</a></li>
              
                
                  
                
              <li><a class="" href="/kr/" data-value="/kr/">한국어</a></li>
              
            </ul>
          </li>
        </ul>
      </nav>
    </div><!-- /.navbar-collapse -->
  </nav>
  </div>
</div>

<div class="header-search-wrapper open-search"> 
  <div class="container">
    <div class="big-search">
      <i class="big-search-icon"></i>
      <form id="searchfrm" name="searchForm" autocomplete="on" action="/search" method="get">
        <ul class="tags-wrapper">
          <li class="search-field"><input type="text" name="q" id="autocomplete" class="form-control global-input" autocomplete="off"></li>
        </ul>
      </form>
      <a class="header-search-cancel" href="#"></a>
    </div>
    <div class="nav-auto-complete"></div>
  </div>
</div>
</header>
<link rel="stylesheet" type="text/css" href="https://static-www.elastic.co/static/css/horizon-swiper.min.css?q=200">
<style> 
    
      .m-shortcuts li a.m-search {
        background: url("https://static-www.elastic.co/assets/blt7b9c4fe6528dc4ef/m-search-icon.png?q=200") no-repeat scroll center center rgba(0, 0, 0, 0);
        background-size: contain;}
    
      .m-shortcuts li a.m-docs {
        background: url("https://static-www.elastic.co/assets/blt44d8b7530a76d01c/m-guide-icon.png?q=200") no-repeat scroll center center rgba(0, 0, 0, 0);
        background-size: contain;}
    
      .m-shortcuts li a.m-contact {
        background: url("https://static-www.elastic.co/assets/blt878040795c9d083b/m-contact-icon.png?q=200") no-repeat scroll center center rgba(0, 0, 0, 0);
        background-size: contain;}
    
    
</style>
<script type="text/javascript" src="https://static-www.elastic.co/static/js/horizon-swiper.min.js?q=200"></script>
<script type="text/javascript">
  $(document).ready( function(){
    // if($('#scrollable-pane li').length > 3){
      $('.horizon-swiper').horizonSwiper({
        showItems: 3,
        arrows: true
      }); 
    // }
    
    $('.navbar-toggle').on('click', function(){
      $('.mobile-navigation, .menu-open').hide();
      $('.navigation-wrapper').addClass('mobile-navigation');
      $('.navbar').addClass('menu-open');
      $('.menu-close').show();
    });
    $('.menu-close').on('click', function(){
      $('.navigation-wrapper').removeClass('mobile-navigation');
      $('.navbar').removeClass('menu-open');
      $('.menu-close').hide();
    });

    var active_url = "";

    $(".navbar-mobile-header-icon").click(function(index){
      $('.navigation-wrapper').toggleClass('menu-overlay');
      $(this).toggleClass("navbar-mobile-header-icon-click navbar-mobile-header-icon-out");
      $(".mobile-inner-nav").slideToggle(500);
      $(".mobile-inner-nav .navbar-nav a").each(function( index ) {
        $(this).css({'animation-delay': (index/25)+'0.4s'});
      });
    });

    $('.dropdown-btn').on('click', function(e){
      e.preventDefault();
      setDropdown();
    });
    
    function setDropdown() {
      $('#myDropdown').toggleClass('show');
    }

    $('body').on('click', function(event){
      if (!event.target.matches('.dropdown-btn')) {

        var dropdowns = $(".dropdown-content");
        var i;
        for (i = 0; i < dropdowns.length; i++) {
          var openDropdown = dropdowns[i];
          if (openDropdown.classList.contains('show')) {
            openDropdown.classList.remove('show');
          }
        }
      }
    });

    // if($(window).width() < 769){
    //   var $item = $('.scrollable-panel li'), 
    //       visible = 3, //Set the number of items that will be visible
    //       index = 0, //Starting index
    //       endIndex = ( $item.length / visible ) - 1; //End index (NOTE:: Requires visible to be a factor of $item.length... You can improve this by rounding...)

    //   $('#right-arrow').click(function(){
    //     if(index < endIndex ){
    //       index++;
    //       $item.animate({'left':'-=300px'});
    //     }
    //   });

    //   $('#left-arrow').click(function(){
    //     if(index > 0){
    //       index--;            
    //       $item.animate({'left':'+=300px'});
    //     }
    //   });
    // }
  });
  $(window).resize(function () {
    $('.horizon-swiper').horizonSwiper({
      showItems: 3,
      arrows: true
    });
  });
</script>
    


  





  
  
  
  
    <div class="tertiary-nav">
      <div class="container">
        <div class="p-t-b-15 bdr-btm-e0e0e0 clearfix">
          <div class="breadcrum-wrapper pull-left text-left">
          
            <a href="/guide">Docs</a> 
          
          </div>
          
          
          
        </div>
      </div>
    </div>

    <div class="nav-mobile-dropdown hidden-sm hidden-md hidden-lg bdr-btm-e0e0e0 clearfix">
      <div class="container text-right">
        <div class="breadcrum-wrapper pull-left text-left">
          
              <a href="/guide">Docs</a>
          
        </div>
        
        
      </div>
    </div>
  


<style type="text/css">

  
</style>
    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">   
          
            
        			<!-- <div class="pageheader">
	<div class="common-container">
		
			<h2 class="page-title">Guide template</h2>
		
	</div>
</div> -->


        		
          

          
	<section id="guide">
		<div class="container">
			<div class="row">
			  <!-- start body -->
				
            <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
            <!-- start body -->
<div class="page_header"><b>PLEASE NOTE:</b><br/>We are working on updating this book for the latest version. Some content might be out of date.</div><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch: The Definitive Guide
      [master]
    </a></span> » <span class="breadcrumb-link"><a href="getting-started.html">Getting Started </a></span> » <span class="breadcrumb-link"><a href="data-in-data-out.html">Data In, Data Out</a></span> » <span class="breadcrumb-node">Partial Updates to Documents</span></div><div class="navheader"><span class="prev"><a href="optimistic-concurrency-control.html">
              « 
              Optimistic Concurrency Control</a>
           
        </span><span class="next">
           
          <a href="_retrieving_multiple_documents.html">Retrieving Multiple Documents
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="partial-updates"></a>Partial Updates to Documents<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/master/030_Data/45_Partial_update.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><p>In <a class="xref" href="update-doc.html" title="Updating a Whole Document">Updating a Whole Document</a>, we said that <a id="id-1.4.5.22.2.2" class="indexterm"></a>
<a id="id-1.4.5.22.2.3" class="indexterm"></a><a id="id-1.4.5.22.2.4" class="indexterm"></a>
<a id="id-1.4.5.22.2.5" class="indexterm"></a>the way to update a document is to retrieve
it, change it, and then reindex the whole document. This is true. However, using
the <code class="literal">update</code> API, we can make partial updates like incrementing a counter in a
single request.</p><p>We also said that documents are immutable: they cannot be changed, only
replaced.  The <code class="literal">update</code> API <span class="emphasis"><em>must</em></span> obey the same rules.  Externally, it
appears as though we are partially updating a document in place. Internally,
however, the <code class="literal">update</code> API simply manages the same <span class="emphasis"><em>retrieve-change-reindex</em></span>
process that we have already described. The difference is that this process
happens within a shard, thus avoiding the network overhead of multiple
requests. By reducing the time between the <span class="emphasis"><em>retrieve</em></span> and <span class="emphasis"><em>reindex</em></span> steps, we
also reduce the likelihood of there being conflicting changes from other
processes.</p><p>The simplest form of the <code class="literal">update</code> request accepts a partial document as the
<code class="literal">doc</code> parameter, which just gets merged with the existing document. Objects
are merged together, existing scalar fields are overwritten, and new fields are
added. For instance, we could add a <code class="literal">tags</code> field and a <code class="literal">views</code> field to our
blog post as follows:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-js">POST /website/blog/1/_update
{
   "doc" : {
      "tags" : [ "testing" ],
      "views": 0
   }
}</pre></div><div class="sense_widget" data-snippet="snippets/030_Data/45_Partial_update.json"></div><p>If the request succeeds, we see a response similar to that
of the <code class="literal">index</code> request:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-js">{
   "_index" :   "website",
   "_id" :      "1",
   "_type" :    "blog",
   "_version" : 3
}</pre></div><p>Retrieving the document shows the updated <code class="literal">_source</code> field:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-js">{
   "_index":    "website",
   "_type":     "blog",
   "_id":       "1",
   "_version":  3,
   "found":     true,
   "_source": {
      "title":  "My first blog entry",
      "text":   "Starting to get the hang of this...",
      "tags": [ "testing" ], <a id="CO12-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
      "views":  0 <a id="CO12-2"></a><span><img src="images/icons/callouts/2.png" alt="" /></span>
   }
}</pre></div><div class="sense_widget" data-snippet="snippets/030_Data/45_Partial_update.json"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> <a href="#CO12-2"><span><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
Our new fields have been added to the <code class="literal">_source</code>.
</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_using_scripts_to_make_partial_updates"></a>Using Scripts to Make Partial Updates<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/master/030_Data/45_Partial_update.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>Scripts can be used in the <code class="literal">update</code> API to change the contents of the <code class="literal">_source</code>
field, which <a id="id-1.4.5.22.13.2.3" class="indexterm"></a>is referred to inside an update script as <code class="literal">ctx._source</code>. For
instance, we could use a script to increment the number of <code class="literal">views</code> that our
blog post has had:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-js">POST /website/blog/1/_update
{
   "script" : "ctx._source.views+=1"
}</pre></div><div class="sense_widget" data-snippet="snippets/030_Data/45_Partial_update.json"></div><div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong>Scripting with Groovy</strong></p></div></div></div><p>For those <a id="id-1.4.5.22.13.5.2.1" class="indexterm"></a>
<a id="id-1.4.5.22.13.5.2.2" class="indexterm"></a>
<a id="id-1.4.5.22.13.5.2.3" class="indexterm"></a><a id="id-1.4.5.22.13.5.2.4" class="indexterm"></a>
<a id="id-1.4.5.22.13.5.2.5" class="indexterm"></a>
<a id="id-1.4.5.22.13.5.2.6" class="indexterm"></a>moments when the API just isn’t enough, Elasticsearch allows you to
write your own custom logic in a script.<a id="id-1.4.5.22.13.5.2.7" class="indexterm"></a>
<a id="id-1.4.5.22.13.5.2.8" class="indexterm"></a> Scripting is supported in many APIs
including search, sorting, aggregations, and document updates. Scripts can be passed in as part of the request,
retrieved from the special .scripts index, or loaded from disk.</p><p>The default scripting language <a id="id-1.4.5.22.13.5.3.1" class="indexterm"></a>is <a class="ulink" href="http://groovy.codehaus.org/" target="_top">Groovy</a>, a
fast and expressive scripting language, similar in syntax to JavaScript. It was first introduced
in Elasticsearch version v1.3.0 and it runs in a <span class="emphasis"><em>sandbox</em></span>, however there is vulnerability
in the Groovy scripting engine that allows an attacker to construct
Groovy scripts that escape the sandbox and execute shell commands as the user
running the Elasticsearch Java VM.</p><p>Therefore in versions v1.3.8, v1.4.3, and version v1.5.0 and newer it has been disabled by default.
Alternatively you can disable dynamic Groovy scripts by
adding this setting to the <code class="literal">config/elasticsearch.yml</code> file in all nodes in the
cluster:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-yaml">script.groovy.sandbox.enabled: false</pre></div><p>This will turn off the Groovy sandbox, thus preventing dynamic Groovy scripts
from being accepted as part of a request or retrieved from the special
<code class="literal">.scripts</code> index. You will still be able to use Groovy scripts stored in files
in the <code class="literal">config/scripts/</code> directory on every node.</p><p>If your architecture and security is one that does not need worry about the vulnerability,
for example your Elasticsearch endpoints are only exposed and available to trusted applications,
then you can choose to re-enable the dynamic scripting if it is a feature your application needs.</p><p>You can read more about scripting in the
<a class="ulink" href="https://www.elastic.co/guide/en/elasticsearch/reference/master/modules-scripting.html" target="_top">scripting reference documentation</a>.</p></div><p>We can also use a script to add a new tag to the <code class="literal">tags</code> array.  In this
example we specify the new tag as a parameter rather than hardcoding it in
the script itself. This allows Elasticsearch to reuse the script in the
future, without having to compile a new script every time we want to add
another tag:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-js">POST /website/blog/1/_update
{
   "script" : "ctx._source.tags+=new_tag",
   "params" : {
      "new_tag" : "search"
   }
}</pre></div><div class="sense_widget" data-snippet="snippets/030_Data/45_Partial_update.json"></div><p>Fetching the document shows the effect of the last two requests:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-js">{
   "_index":    "website",
   "_type":     "blog",
   "_id":       "1",
   "_version":  5,
   "found":     true,
   "_source": {
      "title":  "My first blog entry",
      "text":   "Starting to get the hang of this...",
      "tags":  ["testing", "search"], <a id="CO13-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
      "views":  1 <a id="CO13-2"></a><span><img src="images/icons/callouts/2.png" alt="" /></span>
   }
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO13-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">search</code> tag has been appended to the <code class="literal">tags</code> array.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO13-2"><span><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">views</code> field has been incremented.
</p></td></tr></table></div><p>We can even choose to delete a document based on its contents,
by setting <code class="literal">ctx.op</code> to <code class="literal">delete</code>:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-js">POST /website/blog/1/_update
{
   "script" : "ctx.op = ctx._source.views == count ? 'delete' : 'none'",
    "params" : {
        "count": 1
    }
}</pre></div><div class="sense_widget" data-snippet="snippets/030_Data/45_Partial_update.json"></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_updating_a_document_that_may_not_yet_exist"></a>Updating a Document That May Not Yet Exist<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/master/030_Data/45_Partial_update.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>Imagine that we need to store a<a id="id-1.4.5.22.14.2.1" class="indexterm"></a>
<a id="id-1.4.5.22.14.2.2" class="indexterm"></a> page view counter in Elasticsearch. Every time
that a user views a page, we increment the counter for that page.  But if it
is a new page, we can’t be sure that the counter already exists. If we try to
update a nonexistent document, the update will fail.</p><p>In cases like these, we can use<a id="id-1.4.5.22.14.3.1" class="indexterm"></a> the <code class="literal">upsert</code> parameter to specify the
document that should be created if it doesn’t already exist:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-js">POST /website/pageviews/1/_update
{
   "script" : "ctx._source.views+=1",
   "upsert": {
       "views": 1
   }
}</pre></div><div class="sense_widget" data-snippet="snippets/030_Data/45_Upsert.json"></div><p>The first time we run this request, the <code class="literal">upsert</code> value is indexed as a new
document, which  initializes the <code class="literal">views</code> field to <code class="literal">1</code>. On subsequent runs, the
document already exists, so the <code class="literal">script</code> update is applied instead,
incrementing the <code class="literal">views</code> counter.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_updates_and_conflicts"></a>Updates and Conflicts<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/master/030_Data/45_Partial_update.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>In the introduction to this section, we said<a id="id-1.4.5.22.15.2.1" class="indexterm"></a>
<a id="id-1.4.5.22.15.2.2" class="indexterm"></a><a id="id-1.4.5.22.15.2.3" class="indexterm"></a>
<a id="id-1.4.5.22.15.2.4" class="indexterm"></a> that the smaller the window between
the <span class="emphasis"><em>retrieve</em></span> and <span class="emphasis"><em>reindex</em></span> steps, the smaller the opportunity for
conflicting changes. But it doesn’t eliminate the possibility completely. It
is still possible that a request from another process could change the
document before <code class="literal">update</code> has managed to reindex it.</p><p>To avoid losing data, the <code class="literal">update</code> API retrieves the current <code class="literal">_version</code>
of the document in the <span class="emphasis"><em>retrieve</em></span> step, and passes that to the <code class="literal">index</code> request
during the <span class="emphasis"><em>reindex</em></span> step.
If another process has changed the document between retrieve and reindex,
then the <code class="literal">_version</code> number won’t match and the update request will fail.</p><p>For many uses of partial update, it doesn’t matter that a document has been
changed.  For instance, if two processes are both incrementing the page-view counter, it doesn’t matter in which order it happens; if a conflict
occurs, the only thing we need to do is reattempt the update.</p><p>This can be done automatically by<a id="id-1.4.5.22.15.5.1" class="indexterm"></a>
<a id="id-1.4.5.22.15.5.2" class="indexterm"></a><a id="id-1.4.5.22.15.5.3" class="indexterm"></a> setting the <code class="literal">retry_on_conflict</code> parameter to
the number of times that <code class="literal">update</code> should retry before failing; it defaults
to <code class="literal">0</code>.</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-js">POST /website/pageviews/1/_update?retry_on_conflict=5 <a id="CO14-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
{
   "script" : "ctx._source.views+=1",
   "upsert": {
       "views": 0
   }
}</pre></div><div class="sense_widget" data-snippet="snippets/030_Data/45_Upsert.json"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
Retry this update five times before failing.
</p></td></tr></table></div><p>This works well for operations such as incrementing a counter, where the order of
increments does not matter, but in other situations the order of
changes <span class="emphasis"><em>is</em></span> important. Like the <a class="link" href="index-doc.html" title="Indexing a Document"><code class="literal">index</code> API</a>, the <code class="literal">update</code> API
adopts a <span class="emphasis"><em>last-write-wins</em></span> approach by default, but it also accepts a
<code class="literal">version</code> parameter that allows you to use
<a class="link" href="optimistic-concurrency-control.html" title="Optimistic Concurrency Control">optimistic concurrency control</a> to specify
which version of the document you intend to update.</p></div></div><div class="navfooter"><span class="prev"><a href="optimistic-concurrency-control.html">
              « 
              Optimistic Concurrency Control</a>
           
        </span><span class="next">
           
          <a href="_retrieving_multiple_documents.html">Retrieving Multiple Documents
               »
            </a></span></div>
<!-- end body -->

            </div>
            <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
        
					<div id="rtpcontainer" style="display: block;">
						<h3>Top Videos</h3>
						<ul>
							<li><a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">Elasticsearch Demo</a></li>
							<li><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Kibana 101</a></li>
							<li><a href="https://www.elastic.co/webinars/getting-started-logstash?baymax=default&elektra=docs&storm=top-video">Logstash Primer</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</section>

        </div>
      	


<div id="footer-subscribe">
  <div class="subscribe-wrapper">
    <div class="container">
      <div class="subscribe-form-container">
        <div class="subscribe-title">
            <h5>Be in the know with the latest and greatest from Elastic.</h5>
        </div>
        <div class="subscribe-form">
          <form id="mktoForm_1398" class="mktoForm sb-form"></form>
        </div>
      </div>
      <div class="form_thanks hide">
        
          <p>Thanks for subscribing! We'll keep you updated with new releases.</p>
        
      </div>
    </div>
  </div>
</div>
<!--subscribe newsletter end-->

<!-- Footer Section -->
<footer class="footer-wrapper">
  <div class="container">
    <div class="row footer-content">
        
          <div class="col-xs-6 col-sm-3 col-md-3">
              
                <h3><a href="/products">Products ></a></h3>
              
              <ul>
              
                
                  
                    <li><a href="/products/elasticsearch">Elasticsearch</a></li>
                  
                
              
                
                  
                    <li><a href="/products/kibana">Kibana</a></li>
                  
                
              
                
                  
                    <li><a href="/products/beats">Beats</a></li>
                  
                
              
                
                  
                    <li><a href="/products/logstash">Logstash</a></li>
                  
                
              
                
                  
                    <li><a href="/products/x-pack">X-Pack</a></li>
                  
                
              
                
                  
                    <li><a href="/cloud">Elastic Cloud</a></li>
                  
                
              
                
                  
                    <li><a href="/products/x-pack/security">Security (formerly Shield)</a></li>
                  
                
              
                
                  
                    <li><a href="/products/x-pack/alerting">Alerting (via Watcher)</a></li>
                  
                
              
                
                  
                    <li><a href="/products/x-pack/monitoring">Monitoring (formerly Marvel)</a></li>
                  
                
              
                
                  
                    <li><a href="/products/x-pack/graph">Graph</a></li>
                  
                
              
                
                  
                    <li><a href="/products/x-pack/reporting">Reporting</a></li>
                  
                
              
                
                  
                    <li><a href="/products/hadoop">ES-Hadoop</a></li>
                  
                
              
              </ul>
          </div>    
      
          <div class="col-xs-6 col-sm-3 col-md-3">
              
                <h3>Resources</h3>
              
              <ul>
              
                
                  
                    <li><a href="/blog">Blog</a></li>
                  
                
              
                
                  
                    <li><a href="https://cloud-status.elastic.co">Cloud Status</a></li>
                  
                
              
                
                  
                    <li><a href="/community">Community</a></li>
                  
                
              
                
                  
                    <li><a href="/use-cases">Customers & Use Cases</a></li>
                  
                
              
                
                  
                    <li><a href="/guide">Documentation</a></li>
                  
                
              
                
                  
                    <li><a href="/elasticon">Elastic{ON} Events</a></li>
                  
                
              
                
                  
                    <li><a href="https://discuss.elastic.co/">Forums</a></li>
                  
                
              
                
                  
                    <li><a href="/community/meetups">Meetups</a></li>
                  
                
              
                
                  
                    <li><a href="/subscriptions">Subscriptions</a></li>
                  
                
              
                
                  
                    <li><a href="https://support.elastic.co">Support Portal</a></li>
                  
                
              
                
                  
                    <li><a href="/videos">Videos & Webinars</a></li>
                  
                
              
                
                  
                    <li><a href="/training">Training</a></li>
                  
                
              
              </ul>
          </div>    
      
          <div class="col-xs-6 col-sm-3 col-md-3">
              
                <h3><a href="/about">About ></a></h3>
              
              <ul>
              
                
                  
                    <li><a href="/about/careers">Careers/Jobs</a></li>
                  
                
              
                
                  
                    <li><a href="/contact">Contact</a></li>
                  
                
              
                
                  
                    <li><a href="/about/leadership">Leadership</a></li>
                  
                
              
                
                  
                    <li><a href="/about/partners">Partners</a></li>
                  
                
              
                
                  
                    <li><a href="/about/press">Press</a></li>
                  
                
              
              </ul>
          </div>    
      
          <div class="col-xs-6 col-sm-3 col-md-3">
              
                <h3>Language</h3>
              
              <ul>
              
                
                  <li><a href="/" data-value="/">English</a></li>
                
              
                
                  <li><a href="/fr/" data-value="/fr/">Français</a></li>
                
              
                
                  <li><a href="/de/" data-value="/de/">Deutsch</a></li>
                
              
                
                  <li><a href="/jp/" data-value="/jp/">日本語</a></li>
                
              
                
                  <li><a href="/kr/" data-value="/kr/">한국어</a></li>
                
              
              </ul>
          </div>    
       
    </div>
     <!-- Social Media Section -->
    <div class="row social-icon">
      <div class="col-xs-12 col-sm-12 col-md-12">
        <p class="text-center font-size-10 m-0">FOLLOW US</p>
        <ul>
          
          <li class="facebook"><a id="footer_facebook" href="http://www.facebook.com/elastic.co"></a></li>
          
          <li class="twitter"><a id="footer_twitter" href="https://www.twitter.com/elastic"></a></li>
          
          <li class="linkedin"><a id="footer_linkedin" href="https://www.linkedin.com/company/elastic-co"></a></li>
          
          <li class="xing"><a id="footer_xing" href="https://www.xing.com/companies/elastic.co"></a></li>
          
          <li class="youtube"><a id="footer_youtube" href="https://www.youtube.com/user/elasticsearch"></a></li>
          
        </ul>
      </div>
    </div>
    <!-- Social Media Section end-->
    <div class="row">
	<div class="col-xs-12 col-sm-12 col-md-12">
		<div class="copyright">
			<ul>
				<li><a href="/legal/trademarks">Trademarks</a></li>
				<li><a href="/legal/terms-of-use">Terms of Use</a></li>
				<li><a href="/legal/privacy-policy">Privacy</a></li>
				<li><a href="/legal/privacy-and-cookie-policy">Cookie Policy</a></li>
				<li><a href="/brand">Brand</a></li>
			</ul>
			<div class="copyright-content">
				<div class="footer-logo"><a href="/"><img src="/static/images/svg/logo-elastic-footer.svg" class="img-responsive"></a>
				</div>
				<div class="footer-text">
					<p>© 2017. All Rights Reserved - Elasticsearch
					</p>
					<p>Elasticsearch is a trademark of Elasticsearch BV, registered in the U.S. and in other countries
					</p>
					<p>Apache, Apache Lucene, Apache Hadoop, Hadoop, HDFS and the yellow elephant logo are trademarks of the <a href="http://www.apache.org/" target="_blank">Apache Software Foundation</a> in the United States and/or other countries.
					</p>
				</div>
			</div>
		</div>
	</div>
</div>
  </div>
</footer>
<!-- Footer Section end-->

<style type="text/css">
	
    
		.facebook{background:url("https://static-www.elastic.co/assets/bltf546ff2e0a8f2de5/facebook.svg?q=200") no-repeat;}
    
    
      .facebook:hover {background:url("https://static-www.elastic.co/assets/bltc24cf11c714ecfc4/facebook-hover.svg?q=200")}		
    
	
    
		.twitter{background:url("https://static-www.elastic.co/assets/bltdd9556d6b24e2b85/twitter.svg?q=200") no-repeat;}
    
    
      .twitter:hover {background:url("https://static-www.elastic.co/assets/blt90b0372cc07a54d3/twitter-hover.svg?q=200")}		
    
	
    
		.linkedin{background:url("https://static-www.elastic.co/assets/bltc4a77e0f52ce07f1/linkedin.svg?q=200") no-repeat;}
    
    
      .linkedin:hover {background:url("https://static-www.elastic.co/assets/blt01ce654380e4ea6c/linkedin-hover.svg?q=200")}		
    
	
    
		.xing{background:url("https://static-www.elastic.co/assets/bltc6347078dcc9ec76/xing.svg?q=200") no-repeat;}
    
    
      .xing:hover {background:url("https://static-www.elastic.co/assets/bltededebe5f7521a39/xing-hover.svg?q=200")}		
    
	
    
		.youtube{background:url("https://static-www.elastic.co/assets/blt4982061ce1aebc7f/youtube.svg?q=200") no-repeat;}
    
    
      .youtube:hover {background:url("https://static-www.elastic.co/assets/bltddeb6c6404ae81a5/youtube-hover.svg?q=200")}		
    
	
</style>

<script src="//app-lon02.marketo.com/js/forms2/js/forms2.min.js"></script>
<script>
  MktoForms2.whenReady(function (form) {
  //    // Put your code that uses the form object here
  //   $('#Email').attr("placeholder","Email Address");
  //   $('#FirstName').attr("placeholder","First Name");
  //   $('#LastName').attr("placeholder","Last Name");
  //   $('#Form_Message').attr("placeholder","Tell us in your words");
  // // ========================End Mktoform placeholder==================
  });

  MktoForms2.loadForm("//app-lon02.marketo.com", "813-MAM-392", 1398,function(form){
    form.onSuccess(function(form){
      $('#mktoForm_1398').css('display','none');
      $('.subscribe-wrapper .subscribe-form-container').hide();
      $('.subscribe-wrapper').find('.form_thanks').removeClass('hide')
      dataLayer.push({'event': 'mktoFormSubmit'});
        return false;
      });
  });
</script>
      </section>
    </div>
     <script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";	
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","url":"/guide_template"}';
</script>
<script src="https://static-www.elastic.co/static/js/jquery.autocomplete.js?q=200"></script>
<script type="text/javascript" src="https://static-www.elastic.co/static/js/slick.min.js?q=200"></script>
<script src="https://static-www.elastic.co/static/js/nav-v5.js?q=200"></script>
<script src="https://static-www.elastic.co/static/js/script.js?q=200"></script> 
     
     <style></style>
     
  
            <script type="text/javascript" src="docs.js"></script>
<script type='text/javascript' src='https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js?lang=yaml'></script>

            </body>
        
</html>